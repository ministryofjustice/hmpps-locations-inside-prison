{% extends "../../partials/formStep.njk" %}

{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "moj/components/ticket-panel/macro.njk" import mojTicketPanel %}

{% block innerContent %}
  {{ govukDetails({
    summaryText: "What the different types of cell capacity mean",
    html: "<strong>Baseline certified normal accommodation (CNA)</strong><br>" +
    "The number of people that can live in a cell without it being considered overcrowded.<br><br>" +
    "<strong>Working capacity</strong><br>" +
    "The number of people that can currently live in this location based on available beds, furniture and sanitation.<br><br>" +
    "<strong>Maximum capacity</strong><br>" +
    "The maximum number of people that could potentially live in this location."
  }) }}

  {% set autoFillHtml = '<h2 class="govuk-heading-m govuk-!-margin-bottom-5">Apply capacity values to all cells</h2>' %}

  {% for i in [
    {id: 'CNA', label: 'Baseline certified normal accommodation (CNA)'},
    {id: 'WC', label: 'Working capacity'},
    {id: 'MC', label: 'Maximum capacity'}
  ] %}
    {% set autoFillHtml = autoFillHtml + govukInput({
          component: 'govukInput',
          id: 'autoFill' + i.id,
          name: 'autoFill' + i.id,
          classes: 'govuk-input--width-3',
          rows: 1,
          autocomplete: 'off',
          formGroup: {
            beforeInput: {
              html: '<label class="govuk-label govuk-input-prefix--plain" for="autoFill' + i.id + '">' + i.label + '</label>'
            },
            afterInput: {
              html: '<a href="#" class="govuk-link govuk-link--no-visited-state govuk-input-suffix--plain" id="apply-autoFill' + i.id + '">Apply to all</a>'
            }
          }
        }) %}
  {% endfor %}

  {{ mojTicketPanel({
    attributes: {
      'data-qa': 'auto-fill-capacities'
    },
    items: [
      {
        html: autoFillHtml,
        classes: 'govuk-!-margin-bottom-5'
      }
    ]
  }) }}
{% endblock %}

{% block fields %}
  {% set tableRows = [] %}
  {% set cellTypesObject = [] %}
  {% for i in range(0, values['create-cells_cellsToCreate']) -%}
    {% set cellAccommodationType = values['create-cells_set-cell-type_accommodationType' + i] %}
    {% set cellTypes = values['create-cells_set-cell-type_normalCellTypes' + i] if cellAccommodationType == 'NORMAL_ACCOMMODATION' else values['create-cells_set-cell-type_specialistCellTypes' + i] %}

    {% set matchedCells = [] %}
    {% set matchedCell = '' %}

  {% if cellTypes | isArray %}
     {% for selected in cellTypes %}
        {% for cell in specialistCellTypesObject %}
          {% if cell.key == selected %}
            {% set matchedCells = matchedCells.concat(cell.description) %}
          {% endif %}
        {% endfor %}
      {% endfor %}
    {% else %}
     {% for cell in specialistCellTypesObject %}
       {% if cell.key == cellTypes %}
         {% set matchedCell = cell.description %}
       {% endif %}
     {% endfor %}
  {% endif %}

   {% if cellTypes %}
       {% if matchedCells.length %}
           {% set cellTypesText = matchedCells | join(', ') %}
       {% else %}
           {% set cellTypesText = matchedCell %}
       {% endif %}
       {% set cellTypeColumn =
         {  html:
         '<div class="change-remove-container">' +
         cellTypesText +
           '<div class="change-remove-actions">' +
           '<a class="govuk-!-padding-right-1" href="/create-new/' + locationId + '/create-cells/remove-cell-type/' + i + '">Remove</a>' + '  |  ' +
           '<a class="govuk-!-padding-left-1" href="/create-new/' + locationId + '/create-cells/set-cell-type/' + i + '">Change</a>' + '</div>' + '</div>'

         }
       %}
   {% else %}
     {% set cellTypeColumn = {
       html:
             '<a id="add-cell-type" href="/create-new/' + locationId + '/create-cells/set-cell-type/' + i + '">Add</a>'
             }
     %}
   {% endif %}

    {% set tableRows = (tableRows.push([
      {
        classes: 'govuk-table__cell',
        text: locationPathPrefix + '-' + values['create-cells_cellNumber' + i].padStart(3, '0')
      },
      {
        html: callAsMacro(fields['create-cells_baselineCna' + i].component)(fields['create-cells_baselineCna' + i])
      },
      {
        html: callAsMacro(fields['create-cells_workingCapacity' + i].component)(fields['create-cells_workingCapacity' + i])
      },
      {
        html: callAsMacro(fields['create-cells_maximumCapacity' + i].component)(fields['create-cells_maximumCapacity' + i])
      },
      cellTypeColumn
    ]), tableRows) %}
  {% endfor %}

  {{ govukTable({
    firstCellIsHeader: true,
    head: [
      {
        text: "Cell number"
      },
      {
        text: "Baseline CNA"
      },
      {
        text: "Working capacity"
      },
      {
        text: "Maximum capacity"
      },
      {
        text: "Cell type (optional)"
      }
    ],
    rows: tableRows
  }) }}
{% endblock %}

{#
[
      {
        html: govukInput({
          validate: ['numeric'],
          component: 'govukInput',
          id: 'autoFillCna',
          name: 'autoFillCna',
          classes: 'govuk-input--width-3 ',
          rows: 1,
          autocomplete: 'off',
          formGroup: {
            beforeInput: {
              html: '<label class="govuk-label govuk-input-prefix--plain" for="autoFillCna">Baseline certified normal accommodation (CNA)</label>'
            },
            afterInput: {
              html: '<a href="#" class="govuk-link govuk-link--no-visited-state govuk-input-suffix--plain" id="auto-fill-apply-cna">Apply to all</a>'
            }
          }
        }),
        classes: 'govuk-!-margin-bottom-5'
      }
    ]
#}
